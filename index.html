<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>oVice CSV Poll - Integrated</title>
    <style>
        body { font-family: sans-serif; padding: 12px; background: #fff; margin: 0; }
        .poll-card { border: 1px solid #eee; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        h3 { font-size: 18px; margin: 0 0 15px 0; border-left: 4px solid #0096ff; padding-left: 10px; }
        .option-btn {
            display: block; width: 100%; padding: 12px; margin: 8px 0;
            background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px;
            cursor: pointer; text-align: left; position: relative; overflow: hidden;
        }
        .bar { position: absolute; left: 0; top: 0; bottom: 0; background: rgba(0, 150, 255, 0.15); transition: width 0.5s; }
        .label-text { position: relative; z-index: 1; }
        .count { float: right; position: relative; z-index: 1; font-weight: bold; color: #0076cc; }
        #admin-panel {
            margin-top: 20px; padding: 10px; border: 1px dashed #ff4444; border-radius: 8px;
            background: #fff9f9; display: none; /* 初期は非表示 */
        }
        .admin-label { font-size: 11px; font-weight: bold; color: #d32f2f; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="poll-card">
    <h3 id="poll-title">アンケート（CSV読込待ち）</h3>
    <div id="options"></div>

    <div id="admin-panel">
        <span class="admin-label">管理者メニュー: CSVアップロード</span>
        <input type="file" id="csv-file" accept=".csv">
    </div>
</div>

<script>
/**
 * oVice Plugin SDK (Minimal Inline Version)
 * 外部読み込みエラーを回避するため、SDKの核となる通信機能を直接定義します
 */
const OviceMiniSDK = (() => {
    let _onStorageChanged = null;
    window.addEventListener('message', (event) => {
        const data = event.data;
        if (data.type === 'storage' && _onStorageChanged) {
            _onStorageChanged(data.key, data.value);
        }
    });
    return {
        init: () => {
            return new Promise((resolve) => {
                // oVice本体に初期化を通知
                window.parent.postMessage({ type: 'init' }, '*');
                resolve({
                    getUserInfo: () => new Promise(r => {
                        const handler = (e) => {
                            if (e.data.type === 'user_info') {
                                window.removeEventListener('message', handler);
                                r(e.data.user);
                            }
                        };
                        window.addEventListener('message', handler);
                        window.parent.postMessage({ type: 'get_user_info' }, '*');
                    }),
                    getStorage: (key) => new Promise(r => {
                        const handler = (e) => {
                            if (e.data.type === 'get_storage' && e.data.key === key) {
                                window.removeEventListener('message', handler);
                                r(e.data.value);
                            }
                        };
                        window.addEventListener('message', handler);
                        window.parent.postMessage({ type: 'get_storage', key }, '*');
                    }),
                    setStorage: (key, value) => {
                        window.parent.postMessage({ type: 'set_storage', key, value }, '*');
                    },
                    onStorageChanged: (cb) => { _onStorageChanged = cb; }
                });
            });
        }
    };
})();

// --- アプリケーション本体 ---
let ovice = null;
let pollState = { title: "CSVを読み込んでください", options: [], votes: {} };

async function start() {
    // 外部SDKではなく、インライン定義したSDKを使用
    ovice = await OviceMiniSDK.init();
    
    // 権限チェック：管理者だけにパネルを表示
    try {
        const user = await ovice.getUserInfo();
        // roleが owner, admin, manager のいずれか、または permission が 0
        if (['owner', 'admin', 'manager'].includes(user.role) || user.permission === 0) {
            document.getElementById('admin-panel').style.display = 'block';
        }
    } catch (e) {
        console.warn("User info fetch failed. Fallback to hidden admin panel.");
    }

    // ストレージ復元
    const saved = await ovice.getStorage('poll_state');
    if (saved) {
        pollState = saved;
        renderPoll();
    }

    // リアルタイム同期
    ovice.onStorageChanged((key, val) => {
        if (key === 'poll_state') {
            pollState = val;
            renderPoll();
        }
    });

    document.getElementById('csv-file').addEventListener('change', handleFileUpload);
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        const lines = e.target.result.split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");
        if (lines.length > 0) {
            const newOptions = lines.slice(1);
            pollState = {
                title: lines[0],
                options: newOptions,
                votes: newOptions.reduce((acc, opt) => ({ ...acc, [opt]: 0 }), {})
            };
            await ovice.setStorage('poll_state', pollState);
            renderPoll();
        }
    };
    reader.readAsText(file);
}

async function vote(option) {
    pollState.votes[option] = (pollState.votes[option] || 0) + 1;
    await ovice.setStorage('poll_state', pollState);
    renderPoll();
}

function renderPoll() {
    document.getElementById('poll-title').innerText = pollState.title;
    const container = document.getElementById('options');
    container.innerHTML = '';
    const totalVotes = Object.values(pollState.votes).reduce((a, b) => a + b, 0);
    pollState.options.forEach(opt => {
        const count = pollState.votes[opt] || 0;
        const percent = totalVotes === 0 ? 0 : (count / totalVotes) * 100;
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerHTML = `<div class="bar" style="width:${percent}%"></div><span class="label-text">${opt}</span><span class="count">${count}</span>`;
        btn.onclick = () => vote(opt);
        container.appendChild(btn);
    });
}

start();
</script>
</body>
</html>