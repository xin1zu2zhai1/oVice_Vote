<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>oVice Poll Sync Final</title>
    <style>
        body { font-family: sans-serif; padding: 12px; background: #fff; margin: 0; }
        .poll-card { border: 1px solid #eee; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        h3 { font-size: 18px; margin: 0 0 15px 0; border-left: 4px solid #0096ff; padding-left: 10px; }
        .option-btn {
            display: block; width: 100%; padding: 12px; margin: 8px 0;
            background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px;
            cursor: pointer; text-align: left; position: relative; overflow: hidden;
            user-select: none;
        }
        .bar { position: absolute; left: 0; top: 0; bottom: 0; background: rgba(0, 150, 255, 0.15); transition: width 0.4s; }
        .label-text { position: relative; z-index: 1; }
        .count { float: right; position: relative; z-index: 1; font-weight: bold; color: #0076cc; }
        .status { font-size: 9px; color: #ddd; text-align: right; margin-top: 10px; }
    </style>
</head>
<body>

<div class="poll-card">
    <h3 id="poll-title">Loading...</h3>
    <div id="options"></div>
    <div id="sync-status" class="status">Connecting to oVice...</div>
</div>

<script>
/** * oVice Shared Protocol V3 (公式SDKの通信を完全シミュレート)
 */
const OviceApp = (() => {
    let _onUpdate = null;
    let _callIdx = 0;
    const _waiting = {};

    window.addEventListener('message', (e) => {
        const d = e.data;
        if (!d) return;

        // A. 共有ストレージが更新された通知
        if (d.type === 'storage' || d.event === 'storageChanged') {
            if (_onUpdate) _onUpdate(d.key, d.value);
        }

        // B. getStorageなどのリクエストに対する返信
        if (d.callbackId && _waiting[d.callbackId]) {
            _waiting[d.callbackId](d.value);
            delete _waiting[d.callbackId];
        }
    });

    const call = (type, params = {}) => {
        const callbackId = `poll_${Date.now()}_${++_callIdx}`;
        return new Promise(resolve => {
            _waiting[callbackId] = resolve;
            window.parent.postMessage({ type, callbackId, ...params }, '*');
        });
    };

    return {
        connect: () => call('init'),
        fetch: (key) => call('get_storage', { key }),
        update: (key, value) => window.parent.postMessage({ type: 'set_storage', key, value }, '*'),
        onSync: (cb) => { _onUpdate = cb; }
    };
})();

let pollState = { title: "", options: [], votes: {} };
const SHARED_KEY = 'poll_shared_v3';

async function main() {
    try {
        await OviceApp.connect();
        document.getElementById('sync-status').innerText = "Status: Online";

        // 1. CSV読み込み (構造だけ作成)
        await loadCsv();

        // 2. 他の人と共有されている最新の票を取得
        const cloudVotes = await OviceApp.fetch(SHARED_KEY);
        if (cloudVotes) {
            pollState.votes = typeof cloudVotes === 'string' ? JSON.parse(cloudVotes) : cloudVotes;
        }
        render();

        // 3. 誰かがクリックした時の同期を待機
        OviceApp.onSync((key, val) => {
            if (key === SHARED_KEY) {
                pollState.votes = typeof val === 'string' ? JSON.parse(val) : val;
                render();
                document.getElementById('sync-status').innerText = "Last Update: " + new Date().toLocaleTimeString();
            }
        });

    } catch (e) {
        document.getElementById('sync-status').innerText = "Connection Failed";
    }
}

async function loadCsv() {
    const res = await fetch('vote.csv?t=' + Date.now());
    const text = await res.text();
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");
    if (lines.length > 0) {
        pollState.title = lines[0];
        pollState.options = lines.slice(1);
        pollState.options.forEach(o => { if(!pollState.votes[o]) pollState.votes[o] = 0; });
        render();
    }
}

async function vote(option) {
    // 票を増やして送信
    pollState.votes[option] = (pollState.votes[option] || 0) + 1;
    // 自分でも描画
    render();
    // oVice全体に送信 (これにより全員のonSyncが発火する)
    OviceApp.update(SHARED_KEY, pollState.votes);
}

function render() {
    document.getElementById('poll-title').innerText = pollState.title || "アンケート";
    const container = document.getElementById('options');
    container.innerHTML = '';
    const total = Object.values(pollState.votes).reduce((a, b) => a + b, 0);

    pollState.options.forEach(opt => {
        const count = pollState.votes[opt] || 0;
        const per = total === 0 ? 0 : (count / total) * 100;
        const btn = document.createElement('div');
        btn.className = 'option-btn';
        btn.innerHTML = `<div class="bar" style="width:${per}%"></div><span class="label-text">${opt}</span><span class="count">${count}</span>`;
        btn.onclick = () => vote(opt);
        container.appendChild(btn);
    });
}

main();
</script>
</body>
</html>