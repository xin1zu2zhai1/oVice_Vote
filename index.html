<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>oVice CSV Poll</title>
    <style>
        body { font-family: sans-serif; padding: 12px; background: #fff; margin: 0; color: #333; }
        .poll-card { border: 1px solid #eee; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        h3 { font-size: 18px; margin: 0 0 15px 0; border-left: 4px solid #0096ff; padding-left: 10px; }
        .option-btn {
            display: block; width: 100%; padding: 12px; margin: 8px 0;
            background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px;
            cursor: pointer; text-align: left; position: relative; overflow: hidden;
            font-size: 14px; transition: background 0.2s;
        }
        .option-btn:hover { background: #f0f0f0; }
        .bar { position: absolute; left: 0; top: 0; bottom: 0; background: rgba(0, 150, 255, 0.15); transition: width 0.5s ease-out; }
        .label-text { position: relative; z-index: 1; }
        .count { float: right; position: relative; z-index: 1; font-weight: bold; color: #0076cc; }

        /* 管理者パネルのスタイル（初期は非表示） */
        #admin-panel {
            margin-top: 20px; padding: 15px; border: 1px dashed #ff4444; border-radius: 8px;
            background: #fffafa; display: none;
        }
        .admin-label { font-size: 12px; font-weight: bold; color: #d32f2f; display: block; margin-bottom: 8px; }
        .reset-btn { margin-top: 10px; background: #fff; border: 1px solid #ccc; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
    </style>
</head>
<body>

<div class="poll-card">
    <h3 id="poll-title">アンケート未設定</h3>
    <div id="options"></div>

    <div id="admin-panel">
        <span class="admin-label">⚙️ 管理者専用：CSVアップロード</span>
        <input type="file" id="csv-file" accept=".csv">
        <br>
        <button class="reset-btn" onclick="resetVotes()">投票数をリセット</button>
    </div>
</div>

<script>
/**
 * oVice Minimal SDK - 外部JSを使わずに通信を行う仕組み
 */
const OviceMiniSDK = (() => {
    let _onStorageChanged = null;
    window.addEventListener('message', (e) => {
        if (e.data.type === 'storage' && _onStorageChanged) _onStorageChanged(e.data.key, e.data.value);
    });
    return {
        init: () => new Promise(resolve => {
            window.parent.postMessage({ type: 'init' }, '*');
            resolve({
                getUserInfo: () => new Promise(r => {
                    const h = (e) => { if (e.data.type === 'user_info') { window.removeEventListener('message', h); r(e.data.user); } };
                    window.addEventListener('message', h);
                    window.parent.postMessage({ type: 'get_user_info' }, '*');
                }),
                getStorage: (key) => new Promise(r => {
                    const h = (e) => { if (e.data.type === 'get_storage' && e.data.key === key) { window.removeEventListener('message', h); r(e.data.value); } };
                    window.addEventListener('message', h);
                    window.parent.postMessage({ type: 'get_storage', key }, '*');
                }),
                setStorage: (key, value) => window.parent.postMessage({ type: 'set_storage', key, value }, '*'),
                onStorageChanged: (cb) => { _onStorageChanged = cb; }
            });
        })
    };
})();

let ovice = null;
let pollState = { title: "アンケートを読み込んでください", options: [], votes: {} };

async function start() {
    ovice = await OviceMiniSDK.init();

    // 1. 管理者かどうか判定
    const user = await ovice.getUserInfo();
    if (['owner', 'admin', 'manager'].includes(user.role) || user.permission === 0) {
        document.getElementById('admin-panel').style.display = 'block';
    }

    // 2. データの復元
    const saved = await ovice.getStorage('poll_state');
    if (saved) {
        pollState = saved;
        renderPoll();
    }

    // 3. リアルタイム更新の監視
    ovice.onStorageChanged((key, val) => {
        if (key === 'poll_state') {
            pollState = val;
            renderPoll();
        }
    });

    document.getElementById('csv-file').addEventListener('change', handleFileUpload);
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        const lines = e.target.result.split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");
        if (lines.length > 0) {
            const newOptions = lines.slice(1);
            pollState = {
                title: lines[0],
                options: newOptions,
                votes: newOptions.reduce((acc, opt) => ({ ...acc, [opt]: 0 }), {})
            };
            await ovice.setStorage('poll_state', pollState);
            renderPoll();
        }
    };
    reader.readAsText(file);
}

async function resetVotes() {
    if(!confirm("全ての投票をリセットしますか？")) return;
    pollState.options.forEach(opt => pollState.votes[opt] = 0);
    await ovice.setStorage('poll_state', pollState);
    renderPoll();
}

async function vote(option) {
    pollState.votes[option] = (pollState.votes[option] || 0) + 1;
    await ovice.setStorage('poll_state', pollState);
    renderPoll();
}

function renderPoll() {
    document.getElementById('poll-title').innerText = pollState.title;
    const container = document.getElementById('options');
    container.innerHTML = '';
    const totalVotes = Object.values(pollState.votes).reduce((a, b) => a + b, 0);
    pollState.options.forEach(opt => {
        const count = pollState.votes[opt] || 0;
        const percent = totalVotes === 0 ? 0 : (count / totalVotes) * 100;
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerHTML = `
            <div class="bar" style="width:${percent}%"></div>
            <span class="label-text">${opt}</span>
            <span class="count">${count}</span>
        `;
        btn.onclick = () => vote(opt);
        container.appendChild(btn);
    });
}

start();
</script>
</body>
</html>