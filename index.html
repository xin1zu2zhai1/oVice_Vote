<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>oVice Poll Debug</title>
    <script src="https://unpkg.com/@ovice/plugin-sdk@0.2.1/dist/index.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 10px; background: #fff; font-size: 12px; }
        .box { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .admin-area { background: #fff0f0; border: 2px solid red; display: block; padding: 10px; margin-top: 10px; }
        #log { background: #000; color: #0f0; padding: 10px; font-family: monospace; white-space: pre-wrap; height: 150px; overflow: auto; }
        button { padding: 8px; margin: 5px 0; cursor: pointer; }
    </style>
</head>
<body>

    <div class="box">
        <strong>1. ログ（動作履歴）:</strong>
        <div id="log">起動中...</div>
    </div>

    <div id="admin-panel" class="admin-area">
        <strong>2. 管理者パネル（強制表示中）:</strong><br>
        CSV選択: <input type="file" id="csv-file" accept=".csv"><br>
        <button onclick="resetVotes()">投票リセット</button>
    </div>

    <div class="box">
        <strong>3. アンケート表示エリア:</strong>
        <h3 id="poll-title">未設定</h3>
        <div id="options"></div>
    </div>

<script>
    const logEl = document.getElementById('log');
    function print(msg) {
        logEl.innerText += "\n> " + msg;
        console.log(msg);
    }

    let ovice = null;
    let pollState = { title: "CSVを読み込んでください", options: [], votes: {} };

    async function start() {
        print("Checking SDK object...");
        if (window.OvicePluginSDK) {
            print("SDK object found.");
        } else {
            print("ERROR: SDK object NOT FOUND.");
        }

        try {
            print("Calling SDK.init()...");
            // ここで止まる場合はoVice環境側が原因
            ovice = await window.OvicePluginSDK.init();
            print("SDK.init() SUCCESS!");

            print("Calling getUserInfo()...");
            const user = await ovice.getUserInfo();
            print("User Info: " + JSON.stringify(user));

            // ストレージ読み込み
            const saved = await ovice.getStorage('poll_state');
            if (saved) {
                print("Found saved state.");
                pollState = saved;
                renderPoll();
            }

            ovice.onStorageChanged((key, val) => {
                if (key === 'poll_state') {
                    pollState = val;
                    renderPoll();
                }
            });
        } catch (e) {
            print("EXCEPTION: " + e.message);
        }
    }

    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const lines = e.target.result.split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");
            if (lines.length > 0) {
                const newOptions = lines.slice(1);
                pollState = {
                    title: lines[0],
                    options: newOptions,
                    votes: newOptions.reduce((acc, opt) => ({ ...acc, [opt]: 0 }), {})
                };
                if (ovice) await ovice.setStorage('poll_state', pollState);
                renderPoll();
                print("Poll updated via CSV.");
            }
        };
        reader.readAsText(file);
    }

    async function vote(option) {
        pollState.votes[option] = (pollState.votes[option] || 0) + 1;
        if (ovice) await ovice.setStorage('poll_state', pollState);
        renderPoll();
    }

    function renderPoll() {
        document.getElementById('poll-title').innerText = pollState.title;
        const container = document.getElementById('options');
        container.innerHTML = '';
        pollState.options.forEach(opt => {
            const count = pollState.votes[opt] || 0;
            const btn = document.createElement('button');
            btn.style.width = "100%";
            btn.style.textAlign = "left";
            btn.innerHTML = `${opt} (<b>${count}</b>)`;
            btn.onclick = () => vote(opt);
            container.appendChild(btn);
        });
    }

    document.getElementById('csv-file').addEventListener('change', handleFileUpload);
    start();
</script>
</body>
</html>