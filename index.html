<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>oVice CSV Poll - Auto Load</title>
    <style>
        body { font-family: sans-serif; padding: 12px; background: #fff; margin: 0; color: #333; }
        .poll-card { border: 1px solid #eee; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        h3 { font-size: 18px; margin: 0 0 15px 0; border-left: 4px solid #0096ff; padding-left: 10px; cursor: help; }
        .option-btn {
            display: block; width: 100%; padding: 12px; margin: 8px 0;
            background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px;
            text-align: left; position: relative; overflow: hidden; font-size: 14px;
        }
        .bar { position: absolute; left: 0; top: 0; bottom: 0; background: rgba(0, 150, 255, 0.15); transition: width 0.5s ease-out; }
        .label-text { position: relative; z-index: 1; }
        .count { float: right; position: relative; z-index: 1; font-weight: bold; color: #0076cc; }
        #admin-panel { margin-top: 20px; padding: 10px; border: 1px dashed #ccc; background: #fafafa; display: none; }
        .status-msg { font-size: 10px; color: #999; margin-top: 8px; }
    </style>
</head>
<body>

<div class="poll-card">
    <h3 id="poll-title" onclick="toggleAdmin()">読み込み中...</h3>
    <div id="options"></div>
    <div id="status" class="status-msg"></div>

    <div id="admin-panel">
        <span style="font-size:11px; font-weight:bold;">CSVを手動で上書き:</span><br>
        <input type="file" id="csv-file" accept=".csv" style="font-size:11px;">
    </div>
</div>

<script>
/** SDK内蔵通信ユニット */
const OviceMiniSDK = (() => {
    let _onC = null;
    window.addEventListener('message', e => { if(e.data.type==='storage' && _onC) _onC(e.data.key, e.data.value); });
    return {
        init: () => new Promise(res => { window.parent.postMessage({type:'init'}, '*'); res({
            getStorage: k => new Promise(r => {
                const h = e => { if(e.data.type==='get_storage' && e.data.key===k){ window.removeEventListener('message', h); r(e.data.value); }};
                window.addEventListener('message', h); window.parent.postMessage({type:'get_storage', key:k}, '*');
            }),
            setStorage: (k, v) => window.parent.postMessage({type:'set_storage', key:k, value:v}, '*'),
            onStorageChanged: cb => { _onC = cb; }
        });})
    };
})();

let ovice = null;
let pollState = { title: "", options: [], votes: {} };

async function start() {
    ovice = await OviceMiniSDK.init();

    // 1. まず同じフォルダの vote.csv を読みに行く
    await loadInitialCSV();

    // 2. 投票データの同期
    const saved = await ovice.getStorage('poll_state_votes');
    if (saved) {
        pollState.votes = saved;
        renderPoll();
    }

    ovice.onStorageChanged((key, val) => {
        if (key === 'poll_state_votes') {
            pollState.votes = val;
            renderPoll();
        }
    });

    document.getElementById('csv-file').addEventListener('change', handleFileUpload);
}

// サーバー上の vote.csv を読み込む関数
async function loadInitialCSV() {
    try {
        const res = await fetch('vote.csv?v=' + Date.now());
        if (!res.ok) throw new Error("CSV file not found");
        const text = await res.text();
        parseCSV(text);
        document.getElementById('status').innerText = "Loaded: vote.csv";
    } catch (e) {
        document.getElementById('poll-title').innerText = "vote.csv が見つかりません";
        console.error(e);
    }
}

function parseCSV(text) {
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");
    if (lines.length > 0) {
        pollState.title = lines[0];
        pollState.options = lines.slice(1);
        renderPoll();
    }
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        parseCSV(e.target.result);
        document.getElementById('status').innerText = "Manual Upload Applied";
    };
    reader.readAsText(file);
}

async function vote(option) {
    pollState.votes[option] = (pollState.votes[option] || 0) + 1;
    await ovice.setStorage('poll_state_votes', pollState.votes);
    renderPoll();
}

function renderPoll() {
    document.getElementById('poll-title').innerText = pollState.title || "アンケート";
    const container = document.getElementById('options');
    container.innerHTML = '';
    const total = Object.values(pollState.votes).reduce((a, b) => a + b, 0);
    pollState.options.forEach(opt => {
        const count = pollState.votes[opt] || 0;
        const per = total === 0 ? 0 : (count / total) * 100;
        const btn = document.createElement('div'); // buttonからdivに変更して挙動を安定化
        btn.className = 'option-btn';
        btn.style.cursor = 'pointer';
        btn.innerHTML = `<div class="bar" style="width:${per}%"></div><span class="label-text">${opt}</span><span class="count">${count}</span>`;
        btn.onclick = () => vote(opt);
        container.appendChild(btn);
    });
}

function toggleAdmin() {
    const p = document.getElementById('admin-panel');
    p.style.display = p.style.display === 'block' ? 'none' : 'block';
}

start();
</script>
</body>
</html>